<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIM</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>

    <style>
        .custom-range {
            width: 200px;
            /* Adjusted width */
        }

        .range-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .d-flex.justify-content-between {
            justify-content: space-around;
            /* Adjust spacing for wider sliders */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="d-flex justify-content-between">
            <h1 class="mt-5" id="title">ZIM</h1>
            <div class="text-right mt-5">
                <p>EPS: <span id="epsValue">0.00</span></p>
                <p>Dividend: <span id="dividendValue">0.00</span></p>
                <p>P/FCF: <span id="pfcfValue">0.00</span></p>
            </div>
        </div>
        <p id="shareValue">ZIM quarter</p>

        <div class="d-flex justify-content-between mb-4">
            <div class="range-container text-center">
                <input type="range" class="custom-range" id="teus" min="0" max="3000" value="980"
                    oninput="updateLabel('teus', 'kTEUs')">
                <small id="teusValue">kTEUs: 980</small>
            </div>
            <div class="range-container text-center">
                <input type="range" class="custom-range" id="ccfi" min="0" max="10000" value="1639"
                    oninput="updateLabel('ccfi', 'CCFI $ per TEU')">
                <small id="ccfiValue">CCFI $ per TEU: 1639</small>
            </div>
            <div class="range-container text-center">
                <input type="range" class="custom-range" id="opex" min="0" max="5000" value="1225"
                    oninput="updateLabel('opex', 'OPEX $ per TEU')">
                <small id="opexValue">OPEX $ per TEU: 1225</small>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <canvas id="mySankeyChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
    <script src="bundle.js"></script>
    <script>

        // Declare initial values
        let teus = 980;
        let ccfi = 1639;
        let opex = 1225;

        let sankeyChart;

        async function getRegularMarketPrice() {
            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const targetUrl = encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/ZIM?region=US&lang=en-US&includePrePost=false&interval=1mo&useYfid=true&range=1d&corsDomain=finance.yahoo.com&.tsrc=finance');
            const url = proxyUrl + targetUrl;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const parsedData = JSON.parse(data.contents);

                // Extract the regularMarketPrice from the data
                const regularMarketPrice = parsedData.chart.result[0].meta.regularMarketPrice;

                return regularMarketPrice;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Usage
        getRegularMarketPrice().then(price => {
            console.log('Regular Market Price:', price);
        });
        function updateLabel(rangeId, label) {
            var rangeValue = document.getElementById(rangeId).value;
            rangeValue = Number(rangeValue).toLocaleString('en-US');
            /*if (rangeId === 'teus' || rangeId === 'opex') {
                rangeValue = parseFloat(rangeValue).toFixed(2);
            }*/
            document.getElementById(rangeId + 'Value').textContent = label + ': ' + rangeValue;

            // Update the variables with the new values
            if (rangeId === 'teus') {
                teus = rangeValue;
            } else if (rangeId === 'ccfi') {
                ccfi = rangeValue;
            } else if (rangeId === 'opex') {
                opex = rangeValue;
            }

            // Update the chart with the new values
            updateChart();
        }

        async function calculateValues(teus, ccfi, opex) {
            let revenue_container = teus * 1000 * ccfi;
            let revenue_others = 517000000;

            let total_revenue = revenue_container + revenue_others;
            let opex_cost_services = teus * 1000 * opex;
            let depreciation = 298000000;
            let ga_expenses = 70000000;

            let op_income = total_revenue - opex_cost_services - depreciation - ga_expenses;
            let financial_expenses = 80000000;
            let taxes = Math.round(op_income / 5);
            let net_income = op_income - financial_expenses - taxes;

            const share_price = await getRegularMarketPrice();
            const shares_outstanding = 120321000;

            // Example EPS and Dividend calculations (these should be based on your actual formulas)
            let eps = net_income / shares_outstanding; // Example: EPS = Net Income / 1000 shares
            let dividend = eps * 0.3; // Example: Dividend = 30% of Net Income
            let pfcf = share_price / (eps*4)

            document.getElementById('epsValue').textContent = eps.toFixed(2);
            document.getElementById('title').textContent = `ZIM: $${share_price}`;
            document.getElementById('dividendValue').textContent = dividend.toFixed(2);
            document.getElementById('pfcfValue').textContent = pfcf.toFixed(2);


            let result = {
                revenue_container: Math.round(revenue_container / 1000000),
                revenue_others: Math.round(revenue_others / 1000000),
                total_revenue: Math.round(total_revenue / 1000000),
                opex_cost_services: Math.round(opex_cost_services / 1000000),
                depreciation: Math.round(depreciation / 1000000),
                ga_expenses: Math.round(ga_expenses / 1000000),
                op_income: Math.round(op_income / 1000000),
                financial_expenses: Math.round(financial_expenses / 1000000),
                taxes: Math.round(taxes / 1000000),
                net_income: Math.round(net_income / 1000000),
                eps: eps,
                dividend: dividend
            };

            return result;
        }

        function createSankeyChart(ctx, values) {
            const data = {
                labels: [
                    `Revenue container: M$${values.revenue_container}`,
                    `Revenue others: M$${values.revenue_others}`,
                    `Total revenue: M$${values.total_revenue}`,
                    `OPEX: M$${values.opex_cost_services}`,
                    `G and A: M$${values.ga_expenses}`,
                    `Depreciation: M$${values.depreciation}`,
                    `Operative income: M$${values.op_income}`,
                    `Taxes: M$${values.taxes}`,
                    `Financial expenses: M$${values.financial_expenses}`,
                    `Net income: M$${values.net_income}`
                ],
                datasets: [{
                    label: 'Sankey',
                    data: [
                        { from: `Revenue container: M$${values.revenue_container}`, to: `Total revenue: M$${values.total_revenue}`, flow: values.revenue_container },
                        { from: `Revenue others: M$${values.revenue_others}`, to: `Total revenue: M$${values.total_revenue}`, flow: values.revenue_others },
                        { from: `Total revenue: M$${values.total_revenue}`, to: `OPEX: M$${values.opex_cost_services}`, flow: values.opex_cost_services },
                        { from: `Total revenue: M$${values.total_revenue}`, to: `G and A: M$${values.ga_expenses}`, flow: values.ga_expenses },
                        { from: `Total revenue: M$${values.total_revenue}`, to: `Depreciation: M$${values.depreciation}`, flow: values.depreciation },
                        { from: `Total revenue: M$${values.total_revenue}`, to: `Operative income: M$${values.op_income}`, flow: values.op_income },
                        { from: `Operative income: M$${values.op_income}`, to: `Taxes: M$${values.taxes}`, flow: values.taxes },
                        { from: `Operative income: M$${values.op_income}`, to: `Financial expenses: M$${values.financial_expenses}`, flow: values.financial_expenses },
                        { from: `Operative income: M$${values.op_income}`, to: `Net income: M$${values.net_income}`, flow: values.net_income }
                    ],
                    colorFrom: (context) => context.dataset.data[context.dataIndex].from.includes('Operative income') ? 'grey' : 'grey',
                    colorTo: (context) => {
                        const toLabel = context.dataset.data[context.dataIndex].to;
                        if (toLabel.includes('Net income')) return 'green';
                        if (toLabel.includes('OPEX') || toLabel.includes('Depreciation') || toLabel.includes('G and A') || toLabel.includes('Financial expenses') || toLabel.includes('Taxes')) return 'red';
                        return 'grey';
                    },
                    colorMode: 'gradient',
                    borderWidth: 2
                }]
            };

            const options = {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                },
                animation: false
            };

            if (sankeyChart) {
                sankeyChart.data = data;
                sankeyChart.update();
            } else {
                sankeyChart = new Chart(ctx, {
                    type: 'sankey',
                    data: data,
                    options: options
                });
            }
        }

        async function updateChart() {
            const values = await calculateValues(teus, ccfi, opex);
            createSankeyChart(ctx, values);
        }

        const ctx = document.getElementById('mySankeyChart').getContext('2d');
        const initialValues = calculateValues(teus, ccfi, opex);
        calculateValues(teus, ccfi, opex).then(initialValues => {
            createSankeyChart(ctx, initialValues);
        });


        // Initial calls to updateLabel to set the displayed values correctly
        updateLabel('teus', 'kTEUs');
        updateLabel('ccfi', 'CCFI $ per TEU');
        updateLabel('opex', 'OPEX $ per TEU');
    </script>
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
